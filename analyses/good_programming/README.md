# Literate and reproducible programming

In this course you write your own programs in bash (the shell scripts 
used to automate and control your analyses in the cluster) and R. You also 
use other programs written in a variety of languages, including C, C++, Java, 
and Python.

Your own programs serve two related purposes. First, there is the obvious 
purpose of executing the analysis. Second, though, is a goal that is just as 
important to science as the analysis itself - recording the steps of the 
analysis so that it is fully reproducible.

Your code and your description and interpretation of the analyses can be in 
separate files, such as an R script and a notebook. This can work well in many 
cases, and is certainly a step up from having no documentation at all of what 
you did.

But since the code and your notebook both serve the same purpose it can be more 
convenient and clear to combine them into a single file. This file is  
executable by the computer, allowing you to quickly revise and update your 
analyses, and others to reproduce and modify them. It is also human readable, 
allowing the reader to understand the intent, implementation, and results of 
your work.

This is the world of literate and reproducible programming.


# Embed your notebook into your code as comments

One approach to integrating your code and notebook is to embed your notebook as 
comments right into your program. Comments are bits of text in your program 
file that aren't executed, they are intended only for people that read the 
program file itself. In many languages, including R and Python, text after a 
`#` is ignored when the program is run.

Your analysis could, for example, consist of a file named `my_analysis.r`, and 
have the following contents:

    # The goal of this analysis is to see how will phylogenetically independent 
    # contrasts can reconstruct character covariance when the number of 
    # characters exceeds the number of species. In this case we will look at 30 
    # characters on a tree with 8 species.
    
    # Get set up, and construct the covariance matrix
    library(geiger)
    library(Matrix)
    library(picante)
    
    TrueCov = bdiag(matrix(rep(0.9, 100), 10), matrix(rep(0.5, 100), 10), diag(10))
    diag(TrueCov) = 1
    TrueCov = as.matrix(TrueCov)
    
    # Simulate the tree and data
    tree = rcoal(8)
	plot(tree)
    D = sim.char(tree, TrueCov, nsim=1, model='BM')
	
    # Calculate the independent contrasts
    contrasts = apply( D, 2, function(a) pic(a, tree) )
    
    # Calculate the observed correlations from the contrasts
    ObsCor = cor.table(contrasts)$r
    
    # Display the original and observed matrices
    
    image(TrueCov, main='Original')
    image(ObsCor, main='Observed')
    
    # Relative to the true matrix, the observed matrix is quite noisy. Many of 
    # the elements that should be 0 are instead estimated to be quite strong, 
    # and there is quite a bit of variation within blocks that should be 
    # non-zero.
    #
    # This means that we have to be careful interpretting covariances in 
    # comparative phylogenetic analyses when the number of variables exceeds 
    # the number of species. In particular, there can be many false positives.

You can then run your analysis by entering the following at the command line:

    R CMD BATCH my_analysis.r
    
This will generate two new files. `Rplots.pdf` has the plots that were 
generated by the script. `my_analysis.r.Rout` has the text output of the 
analysis

The `my_analysis.r` file includes all the code needed to execute the analysis, 
a description of the intent and primary question, comments on how the code 
runs, and my interpretations of the results as they pertain to the original 
question. I have achieved all the goals of executing and documenting my 
analyses in a single file.

But there are a few few things that are inconvenient. In particular, the results 
of the analysis are disembodied from the code and supporting discussion. 
Anyone that reviews the analysis (including yourself) will have to flip between 
three files - the source, the text output, and the plots.